/**
 * ActiveRules module
 *
 * Provides support for multi-site hosting using Node.js.
 *
 * @type {exports}
 */

var Site = require('./lib/site') // The Site library is used to apply site specific changes
  , Nugget = require('./lib/nugget') // The Nugget library provides tools for accessing and managing Nuggets.
  , ARutil = require('./lib/util')
  , Promise = require('bluebird') // Promise library ;


/**
 * The file Node.js will start with when requiring the ActiveRules module.
 */
module.exports =  function (nextApp) {

  return function (req) {

    // Define the root directory for the ActiveRules Site configs
    var rootDir = req.env.config.ar.configDir;

    // We use the req hostname to further define how to handle the request.
    var host = req.host;

    // Use the Site library to determine the Site to use in creating the response
    var siteConfig = Site.loadSiteConfig(rootDir, host);

    // Add the siteConfig to the req for use later in creating the JSGI response
    req.env.ar.site = siteConfig;

    // Pass the request along
    return nextApp(req);
  }

}
