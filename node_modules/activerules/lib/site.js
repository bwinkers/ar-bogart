/**
 * ActiveRules Site Library
 */

var Promise = require('bluebird') // Promise library
    , ARutil = require('./util') // ActiveRules Utilities
    , jsonExt = '.json' // The extension to use when looking for JSON config files.

/**
 * Return a Site specific configuration file.
 *
 * @param object req
 * @returns object
 */
exports.loadSiteConfig = function (configDir, hostname) {
    return bestHostConfig(configDir, hostname);
};

/**
 * Use the hostname for determining what Site to use for configuration.
 * A host config MUST have a site property, and its value must be a valid site alias.
 * Values in the host config
 *
 * @param object req
 * @returns object
 */
function bestHostConfig(configDir, hostname) {

    var hostFilePath = configDir + '/hosts/' + hostname + jsonExt;
    var siteFilePath = configDir + '/sites/';
    var siteAlias = 'default';

    ARutil.fileStatus(hostFilePath)
        .done(function (hostStatResult) {
            if (hostStatResult && hostStatResult === 'file') {

                // We found a supported host file
                console.log('Found host config file at: ' + hostFilePath);

                // load the host JSON object from the file
                ARutil.loadJSON(hostFilePath)
                    .done(function (hostConfig) {

                        // Pull the site alias out of the config
                        if (typeof hostConfig.site !== 'undefined') {
                            siteAlias = hostConfig.site;
                        }

                        // Re-write the siteFilePath to include the siteAlias and json extension.
                        siteFilePath = siteFilePath + siteAlias + jsonExt;

                        // Check if the Site config file exists
                        ARutil.fileStatus(siteFilePath)
                            .done(function (siteStatResult) {
                                if (siteStatResult && siteStatResult === 'file') {

                                    // We found a supported site file
                                    console.log('Found site config file at: ' + siteFilePath);

                                    // load the JSON object from the file
                                    ARutil.loadJSON(siteFilePath)
                                        .done(function (siteConfig) {

                                            console.log(siteConfig);
                                        });
                                }
                            })
                    })
            }
        });
}

